<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actions | Stock Screener</title>
    <style>
        :root {
            --graphite-dark: #1a1a1a;
            --graphite-mid: #2d2d2d;
            --graphite-light: #363636;
            --graphite-lighter: #4a4a4a;
            --te-orange: #ff6600;
            --te-orange-dim: #cc5200;
            --te-green: #00cc66;
            --te-green-dim: #009944;
            --te-red: #cc3333;
            --te-red-dim: #991111;
            --text-primary: #e0e0e0;
            --text-secondary: #888888;
            --text-muted: #5a5a5a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--graphite-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        /* Section */
        .section {
            background: var(--graphite-mid);
            border: 1px solid var(--graphite-lighter);
            padding: 30px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--graphite-lighter);
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        /* Dropdown */
        .dropdown-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
        }

        .dropdown {
            padding: 10px 16px;
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--graphite-dark);
            border: 2px solid var(--graphite-lighter);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 160px;
        }

        .dropdown:focus {
            outline: none;
            border-color: var(--te-orange);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--graphite-lighter);
        }

        th {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            font-weight: 600;
            background: var(--graphite-dark);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .badge-buy {
            background: rgba(0, 204, 102, 0.2);
            color: var(--te-green);
        }

        .badge-sell {
            background: rgba(204, 51, 51, 0.2);
            color: var(--te-red);
        }

        .badge-pending {
            background: rgba(255, 102, 0, 0.2);
            color: var(--te-orange);
        }

        .badge-approved {
            background: rgba(0, 204, 102, 0.2);
            color: var(--te-green);
        }

        .badge-rejected {
            background: rgba(204, 51, 51, 0.2);
            color: var(--te-red);
        }

        /* Teenage Engineering Buttons */
        .te-btn {
            display: inline-block;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.15s ease;
        }

        .te-btn-approve {
            background: var(--te-green);
            color: var(--graphite-dark);
            box-shadow: 0 3px 0 var(--te-green-dim);
        }

        .te-btn-approve:hover {
            background: #00dd77;
            transform: translateY(-1px);
        }

        .te-btn-approve:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--te-green-dim);
        }

        .te-btn-reject {
            background: var(--te-red);
            color: var(--text-primary);
            box-shadow: 0 3px 0 var(--te-red-dim);
        }

        .te-btn-reject:hover {
            background: #dd4444;
            transform: translateY(-1px);
        }

        .te-btn-reject:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--te-red-dim);
        }

        .te-btn-secondary {
            background: var(--graphite-light);
            color: var(--text-primary);
            box-shadow: 0 3px 0 var(--graphite-dark);
        }

        .te-btn-secondary:hover {
            background: var(--graphite-lighter);
            transform: translateY(-1px);
        }

        .te-btn-secondary:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--graphite-dark);
        }

        .te-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Input */
        .input-small {
            width: 80px;
            padding: 8px 10px;
            font-family: inherit;
            font-size: 0.85rem;
            background: var(--graphite-dark);
            border: 2px solid var(--graphite-lighter);
            color: var(--text-primary);
            text-align: center;
        }

        .input-small:focus {
            outline: none;
            border-color: var(--te-orange);
        }

        /* Action Buttons Group */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: var(--graphite-dark);
            border: 2px solid var(--graphite-lighter);
            padding: 20px;
            text-align: center;
        }

        .summary-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-value.positive {
            color: var(--te-green);
        }

        .summary-value.negative {
            color: var(--te-red);
        }

        /* Status */
        .status-bar {
            background: var(--graphite-dark);
            border: 2px solid var(--graphite-lighter);
            padding: 16px 20px;
            margin-bottom: 24px;
            display: none;
        }

        .status-bar.active {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-bar.success {
            border-color: var(--te-green);
        }

        .status-bar.error {
            border-color: var(--te-red);
        }

        .status-bar.loading {
            border-color: var(--te-orange);
        }

        .status-text {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        /* Loading Dots */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 5px;
            height: 5px;
            background: var(--te-orange);
            animation: pulse 1.4s infinite;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {

            0%,
            80%,
            100% {
                opacity: 0.3;
            }

            40% {
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Navigation */
        .nav-link {
            display: inline-block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s ease;
            margin-top: 20px;
        }

        .nav-link:hover {
            color: var(--te-orange);
        }

        .nav-link::before {
            content: "← ";
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Actions</h1>
            <p class="subtitle">Approve, Reject & Manage Trade Actions</p>
        </div>

        <div class="status-bar" id="status-bar">
            <span class="status-text" id="status-text"></span>
        </div>

        <!-- Actions Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-title">Trade Actions</span>
                <div class="dropdown-group">
                    <span class="dropdown-label">Date</span>
                    <select class="dropdown" id="actions-date" onchange="loadActions()">
                        <option value="">Select date...</option>
                    </select>
                </div>
            </div>
            <div class="table-container" id="actions-container">
                <div class="empty-state">Select a date to view actions</div>
            </div>
        </div>

        <!-- Holdings Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-title">Holdings</span>
                <div class="dropdown-group">
                    <span class="dropdown-label">Date</span>
                    <select class="dropdown" id="holdings-date" onchange="loadHoldings()">
                        <option value="">Select date...</option>
                    </select>
                </div>
            </div>
            <div class="table-container" id="holdings-container">
                <div class="empty-state">Select a date to view holdings</div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-title">Portfolio Summary</span>
            </div>
            <div class="summary-grid" id="summary-container">
                <div class="empty-state" style="grid-column: 1 / -1;">
                    Select a holdings date to view summary
                </div>
            </div>
        </div>

        <a href="/" class="nav-link">Back to Dashboard</a>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadActionDates();
            loadHoldingDates();
        });

        function showStatus(message, type = 'loading') {
            const bar = document.getElementById('status-bar');
            const text = document.getElementById('status-text');
            bar.className = 'status-bar active ' + type;
            if (type === 'loading') {
                text.innerHTML = message + ' <span class="loading-dots"><span></span><span></span><span></span></span>';
            } else {
                text.textContent = message;
            }
            if (type !== 'loading') {
                setTimeout(() => bar.className = 'status-bar', 3000);
            }
        }

        function hideStatus() {
            document.getElementById('status-bar').className = 'status-bar';
        }

        // Load action dates dropdown
        async function loadActionDates() {
            try {
                const res = await fetch('/api/v1/investment/actions/dates');
                const data = await res.json();
                const select = document.getElementById('actions-date');
                select.innerHTML = '<option value="">Select date...</option>';
                (data.dates || []).forEach(date => {
                    const opt = document.createElement('option');
                    opt.value = date;
                    opt.textContent = date;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load action dates', e);
            }
        }

        // Load holding dates dropdown
        async function loadHoldingDates() {
            try {
                const res = await fetch('/api/v1/investment/holdings/dates');
                const data = await res.json();
                const select = document.getElementById('holdings-date');
                select.innerHTML = '<option value="">Select date...</option>';
                (data.dates || []).forEach(date => {
                    const opt = document.createElement('option');
                    opt.value = date;
                    opt.textContent = date;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load holding dates', e);
            }
        }

        // Load actions for selected date
        async function loadActions() {
            const date = document.getElementById('actions-date').value;
            const container = document.getElementById('actions-container');

            if (!date) {
                container.innerHTML = '<div class="empty-state">Select a date to view actions</div>';
                return;
            }

            try {
                const res = await fetch(`/api/v1/investment/actions?date=${date}`);
                const actions = await res.json();

                if (!actions.length) {
                    container.innerHTML = '<div class="empty-state">No actions for this date</div>';
                    return;
                }

                let html = `<table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Units</th>
                            <th>Price</th>
                            <th>Risk</th>
                            <th>Capital</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                actions.forEach(a => {
                    const typeBadge = a.type === 'buy'
                        ? '<span class="badge badge-buy">BUY</span>'
                        : '<span class="badge badge-sell">SELL</span>';

                    let statusBadge = '<span class="badge badge-pending">PENDING</span>';
                    if (a.status === 'Approved') {
                        statusBadge = '<span class="badge badge-approved">APPROVED</span>';
                    } else if (a.status === 'Rejected') {
                        statusBadge = '<span class="badge badge-rejected">REJECTED</span>';
                    }

                    const isPending = a.status === 'Pending';
                    const unitsInput = isPending
                        ? `<input type="number" class="input-small" id="units-${a.action_id}" value="${a.units}" min="1">`
                        : a.units;

                    const executionInput = isPending
                        ? `<input type="number" class="input-small" id="price-${a.action_id}" value="${a.prev_close}" step="0.01">`
                        : (a.execution_price || a.prev_close);

                    const actionBtns = isPending
                        ? `<div class="action-btns">
                            <button class="te-btn te-btn-approve" onclick="updateAction('${a.action_id}', 'Approved')">Approve</button>
                            <button class="te-btn te-btn-reject" onclick="updateAction('${a.action_id}', 'Rejected')">Reject</button>
                           </div>`
                        : '-';

                    html += `<tr>
                        <td><strong>${a.symbol}</strong></td>
                        <td>${typeBadge}</td>
                        <td>${a.reason || '-'}</td>
                        <td>${unitsInput}</td>
                        <td>₹${executionInput}</td>
                        <td>₹${parseFloat(a.risk || 0).toFixed(2)}</td>
                        <td>₹${parseFloat(a.capital || 0).toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>${actionBtns}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (e) {
                console.error('Failed to load actions', e);
                container.innerHTML = '<div class="empty-state">Error loading actions</div>';
            }
        }

        // Update action (approve/reject)
        async function updateAction(actionId, status) {
            const unitsInput = document.getElementById(`units-${actionId}`);
            const priceInput = document.getElementById(`price-${actionId}`);

            const data = { status };

            if (unitsInput) {
                data.units = parseInt(unitsInput.value);
            }

            if (priceInput && status === 'Approved') {
                data.execution_price = priceInput.value;
            }

            showStatus(`Updating action...`);

            try {
                const res = await fetch(`/api/v1/investment/actions/${actionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    showStatus(`✓ Action ${status.toLowerCase()} successfully`, 'success');
                    loadActions();
                } else {
                    showStatus(`✗ ${result.message || 'Failed to update action'}`, 'error');
                }
            } catch (e) {
                showStatus(`✗ ${e.message}`, 'error');
            }
        }

        // Load holdings for selected date
        async function loadHoldings() {
            const date = document.getElementById('holdings-date').value;
            const container = document.getElementById('holdings-container');

            if (!date) {
                container.innerHTML = '<div class="empty-state">Select a date to view holdings</div>';
                document.getElementById('summary-container').innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Select a holdings date to view summary</div>';
                return;
            }

            try {
                const res = await fetch(`/api/v1/investment/holdings?date=${date}`);
                const holdings = await res.json();

                if (!holdings.length) {
                    container.innerHTML = '<div class="empty-state">No holdings for this date</div>';
                } else {
                    let html = `<table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Entry Date</th>
                                <th>Entry Price</th>
                                <th>Units</th>
                                <th>Score</th>
                                <th>Current Price</th>
                                <th>Entry SL</th>
                                <th>Current SL</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    holdings.forEach(h => {
                        html += `<tr>
                            <td><strong>${h.symbol}</strong></td>
                            <td>${h.entry_date}</td>
                            <td>₹${parseFloat(h.entry_price || 0).toFixed(2)}</td>
                            <td>${h.units}</td>
                            <td>${parseFloat(h.score || 0).toFixed(2)}</td>
                            <td>₹${parseFloat(h.current_price || 0).toFixed(2)}</td>
                            <td>₹${parseFloat(h.entry_sl || 0).toFixed(2)}</td>
                            <td>₹${parseFloat(h.current_sl || 0).toFixed(2)}</td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                }

                // Load summary for the same date
                loadSummary(date);

            } catch (e) {
                console.error('Failed to load holdings', e);
                container.innerHTML = '<div class="empty-state">Error loading holdings</div>';
            }
        }

        // Load summary for selected date
        async function loadSummary(date) {
            const container = document.getElementById('summary-container');

            try {
                const res = await fetch(`/api/v1/investment/summary?date=${date}`);
                const summary = await res.json();

                if (!summary.working_date) {
                    container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">No summary data for this date</div>';
                    return;
                }

                const gain = parseFloat(summary.gain || 0);
                const gainPct = parseFloat(summary.gain_percentage || 0);
                const gainClass = gain >= 0 ? 'positive' : 'negative';

                container.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-label">Starting Capital</div>
                        <div class="summary-value">₹${parseFloat(summary.starting_capital || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Portfolio Value</div>
                        <div class="summary-value">₹${parseFloat(summary.portfolio_value || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Remaining Capital</div>
                        <div class="summary-value">₹${parseFloat(summary.remaining_capital || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Bought</div>
                        <div class="summary-value">₹${parseFloat(summary.bought || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Sold</div>
                        <div class="summary-value">₹${parseFloat(summary.sold || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Gain</div>
                        <div class="summary-value ${gainClass}">₹${gain.toLocaleString('en-IN')} (${gainPct.toFixed(2)}%)</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Portfolio Risk</div>
                        <div class="summary-value">₹${parseFloat(summary.portfolio_risk || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Capital Risk</div>
                        <div class="summary-value">₹${parseFloat(summary.capital_risk || 0).toLocaleString('en-IN')}</div>
                    </div>
                `;

            } catch (e) {
                console.error('Failed to load summary', e);
                container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Error loading summary</div>';
            }
        }
    </script>
</body>

</html>