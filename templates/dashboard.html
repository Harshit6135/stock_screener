<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-panel: #181b21;
            --bg-input: #232730;
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #2d3748;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-bar {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 2px;
            background: var(--bg-dark);
            padding: 10px 20px 0;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tab-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-bottom: none;
            color: var(--text-muted);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-input);
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .tab-pane {
            display: none;
            height: 100%;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Components --- */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-top: 0;
            font-size: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn:disabled {
            background: var(--bg-input);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        input,
        select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: var(--font-main);
        }

        /* --- Grid Layouts --- */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        /* --- Tables --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* --- DataTables Dark Theme Overrides --- */
        table.dataTable {
            border-collapse: collapse;
            width: 100%;
            color: var(--text-main);
            font-size: 0.9rem;
            margin-top: 10px !important;
            margin-bottom: 10px !important;
            border-bottom: 1px solid var(--border);
        }

        table.dataTable thead th,
        table.dataTable thead td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 600;
            text-align: left;
            border-top: none;
        }

        table.dataTable tbody tr {
            background-color: transparent !important;
        }

        table.dataTable tbody th,
        table.dataTable tbody td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            border-top: none !important;
        }

        table.dataTable tbody tr:hover {
            background: rgba(255, 255, 255, 0.02) !important;
        }

        table.dataTable.no-footer {
            border-bottom: 1px solid var(--border);
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: var(--text-muted);
            margin-bottom: 15px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background-color: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px;
            outline: none;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--text-muted) !important;
            padding: 4px 10px;
            margin: 0 2px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: var(--bg-input) !important;
            color: white !important;
            border: 1px solid var(--border);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background: var(--accent) !important;
            color: white !important;
            border: 1px solid var(--accent) !important;
            box-shadow: none !important;
        }

        .text-right {
            text-align: right !important;
        }

        .text-center {
            text-align: center !important;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .badge-swap {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge-neutral {
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .pos-val {
            color: var(--success);
        }

        .neg-val {
            color: var(--danger);
        }

        /* --- Pipeline Specific --- */
        .step-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-input);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* --- Console/Logs --- */
        .console-output {
            background: #000;
            color: #bbc;
            font-family: var(--font-mono);
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
            white-space: pre-wrap;
        }

        .metric-card {
            text-align: center;
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .hidden {
            display: none !important;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-input);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loading-overlay" class="hidden">
        <div style="text-align:center">
            <div class="spinner"></div>
            <p id="loading-text" style="margin-top:15px; font-weight:500;">Processing...</p>
        </div>
    </div>

    <!-- Approve Modal -->
    <div id="approve-modal" class="hidden"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1001;display:flex;align-items:center;justify-content:center;">
        <div
            style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:30px;min-width:400px;max-width:500px;">
            <h3 style="margin-bottom:20px;" id="approve-modal-title">Approve Action</h3>
            <input type="hidden" id="approve-action-id">
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Symbol</label>
                <input type="text" id="approve-symbol" readonly
                    style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-weight:600;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Units</label>
                <input type="number" id="approve-units"
                    style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Execution
                    Price</label>
                <input type="number" step="0.01" id="approve-price"
                    style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn" onclick="closeApproveModal()" style="background:var(--bg);">Cancel</button>
                <button class="btn btn-success" onclick="confirmApprove()">Confirm Approve</button>
            </div>
        </div>
    </div>

    <!-- Manual Buy Modal -->
    <div id="manual-buy-modal" class="hidden"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1001;display:flex;align-items:center;justify-content:center;">
        <div
            style="background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:30px;min-width:400px;max-width:500px;">
            <h3 style="margin-bottom:20px; color:var(--success);">Manual Buy</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Symbol</label>
                <input type="text" id="mb-symbol" style="width:100%;" placeholder="e.g. RELIANCE">
            </div>
            <div class="grid-2" style="margin-bottom:15px;">
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Date</label>
                    <input type="date" id="mb-date" style="width:100%;">
                </div>
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Price</label>
                    <input type="number" step="0.05" id="mb-price" style="width:100%;" oninput="calcUnits()">
                </div>
            </div>
            <div class="grid-2" style="margin-bottom:15px;">
                <div>
                    <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Capital
                        (‚Çπ)</label>
                    <input type="number" id="mb-capital" style="width:100%;" oninput="calcUnits()">
                </div>
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Units</label>
                    <input type="number" id="mb-units" style="width:100%;" oninput="calcCapital()">
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Reason</label>
                <input type="text" id="mb-reason" value="Manual Buy" style="width:100%;">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn" onclick="document.getElementById('manual-buy-modal').classList.add('hidden')"
                    style="background:var(--bg-input);">Cancel</button>
                <button class="btn btn-success" onclick="submitManualBuy()">Submit Buy</button>
            </div>
        </div>
    </div>

    <!-- Manual Sell Modal -->
    <div id="manual-sell-modal" class="hidden"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1001;display:flex;align-items:center;justify-content:center;">
        <div
            style="background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:30px;min-width:400px;max-width:500px;">
            <h3 style="margin-bottom:20px; color:var(--danger);">Manual Sell</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Symbol</label>
                <input type="text" id="ms-symbol" style="width:100%;" placeholder="e.g. RELIANCE">
            </div>
            <div class="grid-2" style="margin-bottom:15px;">
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Date</label>
                    <input type="date" id="ms-date" style="width:100%;">
                </div>
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Units</label>
                    <input type="number" id="ms-units" style="width:100%;">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Price</label>
                <input type="number" step="0.05" id="ms-price" style="width:100%;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Reason</label>
                <input type="text" id="ms-reason" value="Manual Sell" style="width:100%;">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn" onclick="document.getElementById('manual-sell-modal').classList.add('hidden')"
                    style="background:var(--bg-input);">Cancel</button>
                <button class="btn btn-danger" onclick="submitManualSell()">Submit Sell</button>
            </div>
        </div>
    </div>

    <!-- Capital Event Modal -->
    <div id="capital-event-modal" class="hidden"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1001;display:flex;align-items:center;justify-content:center;">
        <div
            style="background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:30px;min-width:400px;max-width:500px;">
            <h3 style="margin-bottom:20px; color:var(--warning);">Capital Event</h3>
            <div class="grid-2" style="margin-bottom:15px;">
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Date</label>
                    <input type="date" id="ce-date" style="width:100%;">
                </div>
                <div>
                    <label
                        style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Type</label>
                    <select id="ce-type" style="width:100%;">
                        <option value="infusion">Deposit (Infusion)</option>
                        <option value="withdrawal">Withdrawal</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Amount
                    (‚Çπ)</label>
                <input type="number" step="1000" id="ce-amount" style="width:100%;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;color:var(--text-muted);font-size:0.85rem;">Note</label>
                <input type="text" id="ce-note" placeholder="Optional note" style="width:100%;">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn" onclick="document.getElementById('capital-event-modal').classList.add('hidden')"
                    style="background:var(--bg-input);">Cancel</button>
                <button class="btn btn-warning" onclick="submitCapitalEvent()">Submit</button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo">
            <span style="color:var(--accent)">ANTIGRAVITY</span> STOCK SCREENER
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('pipeline')">Pipeline</button>
        <button class="tab-btn" onclick="switchTab('portfolio')">Portfolio</button>
        <button class="tab-btn" onclick="switchTab('actions')">Actions</button>
        <button class="tab-btn" onclick="switchTab('backtest')">Backtest</button>
        <button class="tab-btn" onclick="switchTab('config')">Configuration</button>
    </div>

    <!-- PIPELINE TAB -->
    <div id="tab-pipeline" class="tab-pane active main-content">
        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <h3>Data Pipeline Orchestration</h3>


            <div class="step-row">
                <span>0. Kite Authentication</span>
                <span style="font-size:0.8em; color: var(--muted);">always runs</span>
            </div>
            <div class="step-row">
                <span>1. Init App &amp; Instrument Sync</span>
                <label class="switch"><input type="checkbox" id="step-init" checked><span class="slider"></span></label>
            </div>
            <div class="step-row">
                <span style="font-size: 0.8rem; margin-left:20px; color:var(--text-muted);">‚Ü≥ YFinance Batch
                    Size:</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="number" id="yf-batch" value="100"
                        style="width: 70px; background:var(--bg-lighter); color:white; border:1px solid #333; padding:5px; border-radius:4px;">
                    <span style="font-size: 0.8rem; color:var(--text-muted);">Sleep (s):</span>
                    <input type="number" id="yf-sleep" value="4"
                        style="width: 60px; background:var(--bg-lighter); color:white; border:1px solid #333; padding:5px; border-radius:4px;">
                </div>
            </div>
            <div class="step-row">
                <span>2. Update Market Data</span>
                <label class="switch"><input type="checkbox" id="step-market" checked><span
                        class="slider"></span></label>
            </div>
            <div class="step-row">
                <span style="margin-left: 20px; font-size: 0.9em;">‚Ü≥ Historical Mode</span>
                <label class="switch"><input type="checkbox" id="step-historical"><span class="slider"></span></label>
            </div>
            <div class="step-row">
                <span>3. Calculate Indicators</span>
                <label class="switch"><input type="checkbox" id="step-ind" checked><span class="slider"></span></label>
            </div>
            <div class="step-row">
                <span>4. Calculate Percentiles</span>
                <label class="switch"><input type="checkbox" id="step-pct" checked><span class="slider"></span></label>
            </div>
            <div class="step-row">
                <span>5. Calculate Scores</span>
                <label class="switch"><input type="checkbox" id="step-score" checked><span
                        class="slider"></span></label>
            </div>
            <div class="step-row">
                <span>6. Generate Rankings</span>
                <label class="switch"><input type="checkbox" id="step-rank" checked><span class="slider"></span></label>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-warning" onclick="syncInstruments()" id="sync-instr-btn">üîÑ Sync
                    Instruments</button>
                <button class="btn" onclick="runPipeline()">Run Selected Steps</button>
            </div>
        </div>

        <div class="card" style="max-width: 800px; margin: 20px auto;">
            <h3>Sanitization & Cleanup</h3>
            <div class="grid-2">
                <div>
                    <label>Cleanup Data After:</label>
                    <input type="date" id="cleanup-date" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn btn-warning" onclick="runCleanup()">üõë Delete Data</button>
                </div>
            </div>
        </div>

        <div class="card" style="max-width: 800px; margin: 20px auto;">
            <h3>Console Output</h3>
            <div id="pipeline-console" class="console-output">Ready to run...</div>
        </div>
    </div>

    <!-- PORTFOLIO TAB -->
    <div id="tab-portfolio" class="tab-pane main-content">
        <!-- Summary Cards -->
        <div class="grid-3" id="summary-cards" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
            <div class="metric-card">
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-value" id="sum-val">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Invested Capital</div>
                <div class="metric-value" id="sum-inv">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Unrealized Gain</div>
                <div class="metric-value" id="sum-unrealized">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Realized Gain</div>
                <div class="metric-value" id="sum-realized">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Remaining Cash</div>
                <div class="metric-value" id="sum-cash">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Absolute Return %</div>
                <div class="metric-value" id="sum-abs-return">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">XIRR (Annualized)</div>
                <div class="metric-value" id="sum-xirr">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Portfolio Risk</div>
                <div class="metric-value" id="sum-portfolio-risk">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Capital Risk</div>
                <div class="metric-value" id="sum-capital-risk">-</div>
            </div>
            <div class="metric-card" id="day-pnl-card" style="border-left:3px solid var(--accent);">
                <div class="metric-label">Today's P&L</div>
                <div class="metric-value" id="sum-day-pnl">-</div>
                <div style="font-size:0.75rem; color:var(--text-muted);" id="live-status-label">‚è∏ Not streaming</div>
            </div>
        </div>

        <!-- Equity Curve & Drawdown Charts -->
        <div class="grid-2">
            <div class="card">
                <h3>Equity Curve</h3>
                <div style="height:280px;">
                    <canvas id="equityCurveChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Drawdown</h3>
                <div style="height:280px;">
                    <canvas id="drawdownChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Current Holdings</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn" id="live-toggle-btn"
                        style="font-size:0.85rem; padding:6px 12px; background:var(--accent); color:white;"
                        onclick="toggleLiveStream()">üì° Go Live</button>
                    <button class="btn btn-warning"
                        style="font-size:0.85rem; padding:6px 12px; background:#f59e0b; color:black;"
                        onclick="openCapitalEventModal()">üí∞ Capital Event</button>
                    <button class="btn btn-success" style="font-size:0.85rem; padding:6px 12px;"
                        onclick="openManualBuy()">+ Buy</button>
                    <button class="btn btn-danger" style="font-size:0.85rem; padding:6px 12px;"
                        onclick="openManualSell()">- Sell</button>
                    <button class="btn" style="font-size:0.85rem; padding:6px 12px;" onclick="refreshPortfolio()">‚Üª
                        Prices</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table id="holdings-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th class="text-center">Entry Date</th>
                            <th class="text-center">Units</th>
                            <th class="text-center">Avg Price</th>
                            <th class="text-center">Current</th>
                            <th class="text-center">SL</th>
                            <th class="text-center">Cap. Risk</th>
                            <th class="text-center">Invested</th>
                            <th class="text-center">Value</th>
                            <th class="text-center">Unrealized P&L</th>
                            <th class="text-center">%</th>
                            <th class="text-center">Day P&L</th>
                        </tr>
                    </thead>
                    <tbody id="holdings-body"></tbody>
                    <tfoot id="holdings-foot"></tfoot>
                </table>
            </div>
        </div>

        <!-- Live PnL Chart (Hidden by default) -->
        <div class="card" id="live-pnl-card" style="display:none; margin-bottom: 20px;">
            <h3>Live Today's P&L</h3>
            <div style="height:250px;">
                <canvas id="livePnlChart"></canvas>
            </div>
        </div>

        <!-- Trade Journal -->
        <div class="card">
            <h3>Trade Journal (Closed Trades)</h3>
            <div style="overflow-x:auto;">
                <table id="journal-table">
                    <thead>
                        <tr>
                            <th>Entry Date</th>
                            <th>Exit Date</th>
                            <th>Symbol</th>
                            <th>Units</th>
                            <th class="text-right">Entry Price</th>
                            <th class="text-right">Exit Price</th>
                            <th class="text-right">P&L</th>
                            <th class="text-right">Return %</th>
                            <th>Days</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="journal-body">
                        <tr>
                            <td colspan="10" class="text-center" style="padding:20px;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>Top 20 Rankings</h3>
                <table id="rankings-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Symbol</th>
                            <th class="text-right">Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Portfolio Distribution</h3>
                <div style="height:250px;">
                    <canvas id="portfolioChart"></canvas>
                </div>
                <p style="text-align:center; color:var(--text-muted); margin-top:20px;">
                    Positions: <span id="pos-count">0</span> / <span id="max-pos">-</span>
                </p>
            </div>
        </div>
    </div>

    <!-- ACTIONS TAB -->
    <div id="tab-actions" class="tab-pane main-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <h3>Trading Actions</h3>
                    <input type="date" id="actions-date" onchange="loadActions()">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-success" style="font-size:0.85rem;" onclick="openManualBuy()">+ Manual
                        Buy</button>
                    <button class="btn btn-danger" style="font-size:0.85rem;" onclick="openManualSell()">- Manual
                        Sell</button>
                    <button class="btn btn-warning" onclick="rejectPending()">Reject All Pending</button>
                    <button class="btn btn-success" onclick="approveAll()">Approve All</button>
                    <button class="btn" onclick="processActions()">Process Actions</button>
                </div>
            </div>

            <div style="margin: 15px 0;">
                <button class="btn" onclick="generateActions()">‚ú® Generate New Actions</button>
                <label style="margin-left:15px; font-size:0.9rem; cursor:pointer;"><input type="checkbox"
                        id="pyramid-toggle"> Pyramiding</label>
                <span style="margin-left:10px; font-size:0.8rem; color:var(--text-muted);">
                    Based on latest Friday rankings
                </span>
            </div>

            <table id="actions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Symbol</th>
                        <th>Units</th>
                        <th>Price</th>
                        <th>SL</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="actions-body">
                    <tr>
                        <td colspan="8" class="text-center" style="padding:20px;">Select a date to view actions</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- CONFIG TAB -->
    <div id="tab-config" class="tab-pane main-content">
        <div class="card" style="max-width:600px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Strategy Configuration</h3>
                <select id="config-select" onchange="loadConfig()">
                    <option value="momentum_config">Momentum Strategy</option>
                </select>
            </div>

            <div class="grid-2" style="margin-top:20px;">
                <div>
                    <label>Initial Capital</label>
                    <input type="number" id="conf-initial" style="width:100%">
                </div>
                <div>
                    <label>Risk Threshold (%)</label>
                    <input type="number" step="0.1" id="conf-risk" style="width:100%">
                </div>
                <div>
                    <label>Max Positions</label>
                    <input type="number" id="conf-max" style="width:100%">
                </div>
                <div>
                    <label>Mini Position (%)</label>
                    <input type="number" id="conf-min" style="width:100%">
                </div>
                <div>
                    <label>Exit Threshold Score</label>
                    <input type="number" id="conf-exit" style="width:100%">
                </div>
                <div>
                    <label>SL Multiplier (ATR)</label>
                    <input type="number" step="0.1" id="conf-sl-mult" style="width:100%">
                </div>
                <div>
                    <label>SL Step (% of gain)</label>
                    <input type="number" step="0.01" id="conf-sl-step" style="width:100%">
                </div>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-success" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- BACKTEST TAB -->
    <div id="tab-backtest" class="tab-pane main-content">
        <div class="card">
            <h3>Run Backtest</h3>
            <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Start Date</label>
                    <input type="date" id="bt-start" value="2024-01-01">
                </div>
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">End Date</label>
                    <input type="date" id="bt-end">
                </div>
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Strategy</label>
                    <select id="bt-config">
                        <option value="momentum_config">Momentum Strategy</option>
                    </select>
                </div>
                <div style="display:flex; gap:15px; padding-bottom:10px;">
                    <label style="font-size:0.9rem; cursor:pointer;"><input type="checkbox" id="bt-daily-sl" checked>
                        Daily SL Check</label>
                    <label style="font-size:0.9rem; cursor:pointer;"><input type="checkbox" id="bt-mid-week" checked>
                        Mid-Week Buy</label>
                    <label style="font-size:0.9rem; cursor:pointer;"><input type="checkbox" id="bt-pyramid">
                        Pyramiding</label>
                </div>
                <div>
                    <label style="display:block; font-size:0.8rem; margin-bottom:5px;">Run Label (optional)</label>
                    <input type="text" id="bt-label" placeholder="e.g. Baseline, No SL..." style="width:180px;">
                </div>
                <button class="btn" style="background:#8b5cf6;" onclick="runBacktest()">‚ñ∂ Run Backtest</button>
            </div>
        </div>

        <!-- Backtest Results -->
        <div id="bt-results" class="hidden">
            <!-- Metrics -->
            <div class="grid-4" style="margin-bottom:20px;">
                <div class="metric-card">
                    <div class="metric-label">Total Return</div>
                    <div class="metric-value" id="bt-return" style="color:var(--success)">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div class="metric-value" id="bt-sharpe">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Drawdown</div>
                    <div class="metric-value" id="bt-dd" style="color:var(--danger)">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value" id="bt-winrate">-</div>
                </div>
            </div>

            <!-- Costs, Tax & Efficiency -->
            <div class="grid-4" style="margin-bottom:20px;">
                <div class="card metric-card">
                    <div class="metric-label">Transaction Costs</div>
                    <div class="metric-value" id="bt-costs" style="color:var(--danger)">-</div>
                </div>
                <div class="card metric-card">
                    <div class="metric-label">Estimated Tax</div>
                    <div class="metric-value" id="bt-tax" style="color:var(--danger)">-</div>
                </div>
                <div class="card metric-card">
                    <div class="metric-label">Net Return (Post-Tax)</div>
                    <div class="metric-value" id="bt-net-ret">-</div>
                </div>
                <div class="card metric-card">
                    <div class="metric-label">Efficiency</div>
                    <div class="metric-value" id="bt-efficiency" style="font-size:1rem;">-</div>
                </div>
            </div>

            <!-- YoY Performance -->
            <div class="card" id="bt-yoy-card" class="hidden" style="margin-bottom:20px;">
                <h3>Year-on-Year Performance</h3>
                <div style="max-height:300px; overflow-y:auto;">
                    <table id="bt-yoy-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th class="text-right">Return %</th>
                                <th class="text-right">PnL</th>
                                <th class="text-right">End Value</th>
                            </tr>
                        </thead>
                        <tbody id="bt-yoy-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Equity Curve -->
            <div class="card">
                <h3>Portfolio Equity Curve</h3>
                <div style="height:300px;">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- Trades -->
            <div class="card">
                <h3>Trade Log</h3>
                <div style="max-height:400px; overflow-y:auto;">
                    <table id="bt-trades-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Entry Date</th>
                                <th>Exit Date</th>
                                <th class="text-right">PnL</th>
                                <th class="text-right">Return %</th>
                            </tr>
                        </thead>
                        <tbody id="bt-trades-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Open Positions at Backtest End -->
            <div class="card" id="bt-open-positions-card" class="hidden" style="margin-bottom:20px;">
                <h3>üìå Open Positions at Backtest End (force-closed)</h3>
                <div style="max-height:400px; overflow-y:auto;">
                    <table id="bt-open-positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Entry Date</th>
                                <th class="text-right">Units</th>
                                <th class="text-right">Avg Price</th>
                                <th class="text-right">Close Price</th>
                                <th class="text-right">Market Value</th>
                                <th class="text-right">Unrealized PnL</th>
                            </tr>
                        </thead>
                        <tbody id="bt-open-positions-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Raw Report -->
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Details</h3>
                    <button class="btn" style="font-size:0.8rem;"
                        onclick="document.getElementById('bt-raw-log').classList.toggle('hidden')">Toggle Raw
                        Report</button>
                </div>
                <div id="bt-raw-log" class="console-output hidden"
                    style="margin-top:15px; background:#1e1e1e; color:#eee; height:500px;"></div>
            </div>
        </div>

        <!-- Backtest History (always visible) -->
        <div class="card" style="margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìÇ Run History</h3>
                <button class="btn" style="font-size:0.8rem; background:#475569;" onclick="loadBacktestHistory()">‚ü≥
                    Refresh</button>
            </div>
            <div style="max-height:350px; overflow-y:auto; margin-top:10px;">
                <table id="bt-history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Label</th>
                            <th>Config</th>
                            <th>Date Range</th>
                            <th>Daily SL</th>
                            <th>Mid-Wk Buy</th>
                            <th class="text-right">Return %</th>
                            <th class="text-right">Max DD %</th>
                            <th class="text-right">Sharpe</th>
                            <th>Created</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bt-history-body">
                        <tr>
                            <td colspan="11" class="text-center">No saved runs</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            // Find button that calls this function with this tabId
            // Simple approach: select by index or just iterate. 
            // Better: add specific IDs to buttons. But iterating is fine.
            const btns = document.querySelectorAll('.tab-btn');
            if (tabId === 'pipeline') btns[0].classList.add('active');
            if (tabId === 'portfolio') { btns[1].classList.add('active'); loadPortfolio(); }
            if (tabId === 'actions') { btns[2].classList.add('active'); initActionsDate(); }
            if (tabId === 'backtest') { btns[3].classList.add('active'); initBacktestDates(); loadBacktestHistory(); }
            if (tabId === 'config') { btns[4].classList.add('active'); loadConfig(); }
        }

        function showLoading(msg) {
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function log(msg) {
            const el = document.getElementById('pipeline-console');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div><span style="color:#555">[${time}]</span> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        // --- MANUAL TRADES ---
        function openManualBuy() {
            document.getElementById('mb-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('mb-symbol').value = '';
            document.getElementById('mb-units').value = '';
            document.getElementById('mb-price').value = '';
            document.getElementById('mb-capital').value = '';
            document.getElementById('manual-buy-modal').classList.remove('hidden');
        }

        function openManualSell() {
            document.getElementById('ms-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('ms-symbol').value = '';
            document.getElementById('ms-units').value = '';
            document.getElementById('ms-price').value = '';
            document.getElementById('manual-sell-modal').classList.remove('hidden');
        }

        async function submitManualBuy() {
            const symbol = document.getElementById('mb-symbol').value.toUpperCase();
            const date = document.getElementById('mb-date').value;
            const units = parseInt(document.getElementById('mb-units').value);
            const price = parseFloat(document.getElementById('mb-price').value);
            const reason = document.getElementById('mb-reason').value;

            if (!symbol || !units || !price) return alert('Fill all fields');

            const payload = [{
                symbol: symbol,
                date: date,
                units: units,
                price: price,
                reason: reason,
                config_name: "momentum_config"
            }];

            showLoading('Processing Buy...');
            try {
                const res = await fetch('/api/v1/investment/manual/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    alert('Success: ' + data.message);
                    document.getElementById('manual-buy-modal').classList.add('hidden');
                    loadPortfolio();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (e) { alert(e.message); }
            hideLoading();
        }

        async function submitManualSell() {
            const symbol = document.getElementById('ms-symbol').value.toUpperCase();
            const date = document.getElementById('ms-date').value;
            const units = parseInt(document.getElementById('ms-units').value);
            const price = parseFloat(document.getElementById('ms-price').value);
            const reason = document.getElementById('ms-reason').value;

            if (!symbol || !units || !price) return alert('Fill all fields');

            const payload = {
                symbol: symbol,
                date: date,
                units: units,
                price: price,
                reason: reason
            };

            showLoading('Processing Sell...');
            try {
                const res = await fetch('/api/v1/investment/manual/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    alert('Success: ' + data.message);
                    document.getElementById('manual-sell-modal').classList.add('hidden');
                    loadPortfolio();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (e) { alert(e.message); }
            hideLoading();
        }

        // --- CAPITAL EVENTS ---
        function openCapitalEventModal() {
            document.getElementById('ce-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('ce-amount').value = '';
            document.getElementById('ce-note').value = '';
            document.getElementById('capital-event-modal').classList.remove('hidden');
        }

        async function submitCapitalEvent() {
            const date = document.getElementById('ce-date').value;
            const type = document.getElementById('ce-type').value;
            const amount = parseFloat(document.getElementById('ce-amount').value);
            const note = document.getElementById('ce-note').value;

            if (!amount || amount <= 0) return alert('Enter valid amount');

            showLoading('Processing Capital Event...');
            try {
                const res = await fetch('/api/v1/investment/capital-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: date,
                        event_type: type,
                        amount: amount,
                        note: note
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('Success: ' + data.message);
                    document.getElementById('capital-event-modal').classList.add('hidden');
                    loadPortfolio();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (e) { alert(e.message); }
            hideLoading();
        }


        // --- CALCULATOR ---
        function calcUnits() {
            const capital = parseFloat(document.getElementById('mb-capital').value) || 0;
            const price = parseFloat(document.getElementById('mb-price').value) || 0;
            if (capital > 0 && price > 0) {
                document.getElementById('mb-units').value = Math.floor(capital / price);
            }
        }

        function calcCapital() {
            const units = parseInt(document.getElementById('mb-units').value) || 0;
            const price = parseFloat(document.getElementById('mb-price').value) || 0;
            if (units > 0 && price > 0) {
                document.getElementById('mb-capital').value = (units * price).toFixed(2);
            }
        }

        // --- DataTables Helper ---
        function destroyDataTable(tableId) {
            if ($.fn.DataTable.isDataTable(tableId)) {
                $(tableId).DataTable().destroy();
            }
        }
        function makeTableSortable(tableId, options = {}) {
            $(tableId).DataTable(Object.assign({
                paging: false,
                searching: false,
                info: false,
                order: [],
                autoWidth: false
            }, options));
        }

        // --- Init Helpers ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date for inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cleanup-date').value = today;
            document.getElementById('cleanup-date').value = today;

            // Auto-load portfolio on start
            switchTab('portfolio');
        });

        // --- PIPELINE ---
        async function runPipeline() {
            const payload = {
                init: document.getElementById('step-init').checked,
                marketdata: document.getElementById('step-market').checked,
                historical: document.getElementById('step-historical').checked,
                indicators: document.getElementById('step-ind').checked,
                percentile: document.getElementById('step-pct').checked,
                score: document.getElementById('step-score').checked,
                ranking: document.getElementById('step-rank').checked,
                yfinance_batch_size: parseInt(document.getElementById('yf-batch').value) || 100,
                yfinance_sleep_time: parseInt(document.getElementById('yf-sleep').value) || 4
            };

            const consoleEl = document.getElementById('pipeline-console');
            consoleEl.innerHTML = '';  // clear old output

            // Open SSE log stream BEFORE hitting the pipeline endpoint so every
            // backend log line appears in the console in real-time.
            const es = new EventSource('/api/v1/app/logs/stream');
            es.onmessage = (e) => {
                if (e.data === '[PING]') return;
                const line = document.createElement('div');
                const text = e.data;
                if (text.startsWith('ERROR')) line.style.color = '#ff6b6b';
                else if (text.startsWith('WARNING')) line.style.color = '#ffd93d';
                else line.style.color = '#a8ff78';
                line.textContent = text;
                consoleEl.appendChild(line);
                consoleEl.scrollTop = consoleEl.scrollHeight;
                // Update the loading overlay with the last log line (strip level/name prefix)
                const loadingText = document.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = text.replace(/^[A-Z]+ \| [^\|]+ \| /, '');
            };
            es.onerror = () => es.close();

            showLoading('Pipeline running ‚Äî live logs below...');

            try {
                const res = await fetch('/api/v1/app/run-pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                const stepLabels = {
                    kite_auth: '0. Kite Auth',
                    init: '1. Init App',
                    marketdata: '2. Market Data',
                    indicators: '3. Indicators',
                    percentile: '4. Percentiles',
                    score: '5. Scores',
                    ranking: '6. Rankings',
                };

                log('‚îÄ'.repeat(50));
                if (res.ok) {
                    const aborted = data.message && data.message.includes('aborted');
                    log(aborted ? '‚ö†Ô∏è  Pipeline aborted ‚Äî see steps below:' : '‚úÖ Pipeline Complete!');
                    Object.entries(data.results || {}).forEach(([step, status]) => {
                        const label = stepLabels[step] || step;
                        let icon = '‚úÖ';
                        if (typeof status === 'string' && status.startsWith('failed')) icon = '‚ùå';
                        else if (typeof status === 'string' && status.startsWith('skipped')) icon = '‚è≠';
                        log(`   ${icon} ${label}: ${status}`);
                    });
                } else {
                    log(`‚ùå Error: ${data.message || 'Unknown error'}`);
                }
            } catch (e) {
                log(`‚ùå Network Error: ${e.message}`);
            } finally {
                es.close();
                hideLoading();
            }
        }


        async function syncInstruments() {
            const btn = document.getElementById('sync-instr-btn');
            btn.disabled = true;
            showLoading('Syncing instruments... fetching Kite data');
            log('--> Starting instrument sync (BE/EQ series detection)...');
            try {
                const res = await fetch('/api/v1/init/sync', { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    log(`‚úÖ Instrument Sync Complete!`);
                    log(`   ‚Ä¢ Checked: ${data.checked} symbols`);
                    log(`   ‚Ä¢ Changed: ${data.changed} symbols`);
                    log(`   ‚Ä¢ Errors : ${data.errors} symbols`);
                } else {
                    log(`‚ùå Sync Error: ${data.message || JSON.stringify(data)}`);
                }
            } catch (e) {
                log(`‚ùå Network Error: ${e.message}`);
            }
            hideLoading();
            btn.disabled = false;
        }

        async function runCleanup() {
            const date = document.getElementById('cleanup-date').value;
            if (!date) return alert('Select a date');
            if (!confirm(`Are you sure you want to delete data after ${date}? This cannot be undone.`)) return;

            showLoading('Cleaning up data...');
            try {
                const res = await fetch(`/api/v1/app/cleanup?start_date=${date}`, { method: 'DELETE' });
                const data = await res.json();
                log(`üóë Cleanup result: ${data.message}`);
            } catch (e) {
                log(`‚ùå Cleanup failed: ${e.message}`);
            }
            hideLoading();
        }

        // --- PORTFOLIO ---
        let portfolioChartInstance = null;

        async function loadPortfolio() {
            showLoading('Loading Portfolio...');

            try {
                // 1. Load Config (for max positions)
                // We assume momentum_config for now, or we could make this dynamic
                const cRes = await fetch('/api/v1/config/momentum_config');
                const config = await cRes.json();
                const maxPositions = config.max_positions || 15;
                document.getElementById('max-pos').innerText = maxPositions;

                // 2. Load Holdings (Latest)
                const hRes = await fetch('/api/v1/investment/holdings');
                const holdings = await hRes.json();
                renderHoldings(holdings);
                renderPortfolioChart(holdings);

                // 3. Load Summary (Latest)
                const sRes = await fetch('/api/v1/investment/summary');
                const summary = await sRes.json();

                if (summary && summary.portfolio_value) {
                    const fmt = (v) => parseFloat(v).toLocaleString(undefined, { maximumFractionDigits: 0 });
                    document.getElementById('sum-val').innerText = '‚Çπ' + fmt(summary.portfolio_value);
                    document.getElementById('sum-inv').innerText = '‚Çπ' + fmt(summary.invested_value || 0);

                    const unrealized = parseFloat(summary.unrealized_gain || 0);
                    const realized = parseFloat(summary.realized_gain || 0);

                    const elUnrealized = document.getElementById('sum-unrealized');
                    elUnrealized.innerText = '‚Çπ' + fmt(unrealized);
                    elUnrealized.className = 'metric-value ' + (unrealized >= 0 ? 'pos-val' : 'neg-val');

                    const elRealized = document.getElementById('sum-realized');
                    elRealized.innerText = '‚Çπ' + fmt(realized);
                    elRealized.className = 'metric-value ' + (realized >= 0 ? 'pos-val' : 'neg-val');

                    const elPortfolioRisk = document.getElementById('sum-portfolio-risk');
                    elPortfolioRisk.innerText = '‚Çπ' + fmt(summary.portfolio_risk || 0);
                    elPortfolioRisk.className = 'metric-value ' + (summary.portfolio_risk <= 0 ? 'pos-val' : 'neg-val');

                    const elCapitalRisk = document.getElementById('sum-capital-risk');
                    elCapitalRisk.innerText = '‚Çπ' + fmt(summary.capital_risk || 0);
                    elCapitalRisk.className = 'metric-value ' + (summary.capital_risk <= 0 ? 'pos-val' : 'neg-val');

                    document.getElementById('sum-cash').innerText = '‚Çπ' + fmt(summary.remaining_capital || 0);
                    document.getElementById('pos-count').innerText = holdings.length;

                    // Absolute Return %
                    const absReturn = parseFloat(summary.gain_percentage || 0);
                    const elAbsReturn = document.getElementById('sum-abs-return');
                    elAbsReturn.innerText = absReturn.toFixed(2) + '%';
                    elAbsReturn.className = 'metric-value ' + (absReturn >= 0 ? 'pos-val' : 'neg-val');

                    // XIRR
                    const xirr = summary.xirr;
                    const elXirr = document.getElementById('sum-xirr');
                    if (xirr !== null && xirr !== undefined) {
                        elXirr.innerText = parseFloat(xirr).toFixed(2) + '%';
                        elXirr.className = 'metric-value ' + (xirr >= 0 ? 'pos-val' : 'neg-val');
                    } else {
                        elXirr.innerText = 'N/A';
                    }
                } else {
                    ['sum-val', 'sum-inv', 'sum-unrealized', 'sum-realized', 'sum-cash', 'sum-abs-return', 'sum-xirr'].forEach(id => {
                        document.getElementById(id).innerText = '-';
                    });
                }

                // 4. Load Rankings (Latest)
                const rRes = await fetch('/api/v1/ranking/top/20');
                const rankings = await rRes.json();
                renderRankings(rankings);

                // 5. Load Equity Curve & Drawdown
                loadEquityCurve();

                // 6. Load Trade Journal
                loadTradeJournal();

            } catch (e) {
                console.error(e);
            }
            hideLoading();
        }

        function renderPortfolioChart(holdings) {
            const canvas = document.getElementById('portfolioChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (portfolioChartInstance) {
                portfolioChartInstance.destroy();
            }

            if (!holdings || holdings.length === 0) {
                return;
            }

            const labels = [];
            const data = [];
            const colors = [];

            holdings.forEach((h, i) => {
                const price = parseFloat(h.current_price || 0);
                const units = parseFloat(h.units || 0);
                const val = price * units;

                // Only include non-zero positions to avoid clutter and NaNs
                if (val > 0.01) {
                    labels.push(h.symbol);
                    data.push(val);
                    colors.push(`hsl(${i * 360 / holdings.length}, 70%, 60%)`);
                }
            });

            if (data.length === 0) return;

            portfolioChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: '#181b21'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }



        function renderHoldings(holdings) {
            destroyDataTable('#holdings-table');
            const tbody = document.getElementById('holdings-body');
            const tfoot = document.getElementById('holdings-foot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            if (!holdings || !holdings.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No holdings found for this date</td></tr>';
                return;
            }

            let totalInv = 0, totalVal = 0, totalPnL = 0, totalCapRisk = 0;

            holdings.forEach(h => {
                const entryPrice = parseFloat(h.entry_price || 0);
                const avgPrice = parseFloat(h.avg_price || h.entry_price || 0);
                const currentPrice = parseFloat(h.current_price || 0);
                const currentSl = parseFloat(h.current_sl || 0);
                const units = parseFloat(h.units || 0);

                const inv = avgPrice * units;
                const val = currentPrice * units;
                const pnl = val - inv;
                const pnlPct = inv !== 0 ? (pnl / inv) * 100 : 0;
                const capRisk = units * (avgPrice - currentSl);

                totalInv += inv;
                totalVal += val;
                totalPnL += pnl;
                if (currentSl > 0) totalCapRisk += capRisk;

                const row = `<tr data-symbol="${h.symbol}">
                    <td><strong>${h.symbol}</strong></td>
                    <td class="text-center" data-sort="${h.entry_date}">${h.entry_date}</td>
                    <td class="text-center" data-sort="${units}">${units}</td>
                    <td class="text-center" data-sort="${avgPrice}">‚Çπ${avgPrice.toFixed(2)}</td>
                    <td class="text-center live-current" data-sort="${currentPrice}">‚Çπ${currentPrice.toFixed(2)}</td>
                    <td class="text-center" data-sort="${currentSl}" style="color:var(--danger);">‚Çπ${currentSl.toFixed(2)}</td>
                    <td class="text-center ${capRisk > 0 ? 'neg-val' : 'pos-val'}" data-sort="${capRisk}">‚Çπ${currentSl > 0 ? capRisk.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
                    <td class="text-center" data-sort="${inv}">‚Çπ${inv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center live-value" data-sort="${val}">‚Çπ${val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center live-pnl ${pnl >= 0 ? 'pos-val' : 'neg-val'}" data-sort="${pnl}">‚Çπ${pnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center live-pnlpct ${pnl >= 0 ? 'pos-val' : 'neg-val'}" data-sort="${pnlPct}">${pnlPct.toFixed(2)}%</td>
                    <td class="text-center live-day-pnl" data-sort="0" style="color:var(--text-muted);">-</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Totals
            const totalRow = `<tr style="font-weight:700; background:#232730;">
                    <td colspan="6">TOTALS</td>
                    <td class="text-right ${totalCapRisk > 0 ? 'neg-val' : 'pos-val'}">‚Çπ${totalCapRisk.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right">‚Çπ${totalInv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right" id="live-total-val">‚Çπ${totalVal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right ${totalPnL >= 0 ? 'pos-val' : 'neg-val'}" id="live-total-pnl">‚Çπ${totalPnL.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right ${totalPnL >= 0 ? 'pos-val' : 'neg-val'}">${totalInv !== 0 ? ((totalPnL / totalInv) * 100).toFixed(2) : '0.00'}%</td>
                    <td class="text-right" id="live-total-day-pnl" style="color:var(--text-muted);">-</td>
                </tr>`;
            tfoot.innerHTML = totalRow;
            makeTableSortable('#holdings-table', { searching: true });
        }

        function renderRankings(rankings) {
            destroyDataTable('#rankings-table');
            const body = document.querySelector('#rankings-table tbody');
            body.innerHTML = '';
            rankings.forEach(r => {
                const row = `<tr>
                    <td data-sort="${r.rank}">#${r.rank}</td>
                    <td>${r.tradingsymbol}</td>
                    <td class="text-right" data-sort="${r.composite_score}">${r.composite_score.toFixed(2)}</td>
                </tr>`;
                body.innerHTML += row;
            });
            makeTableSortable('#rankings-table', { paging: true, pageLength: 10, info: true });
        }

        // --- ACTIONS ---
        async function initActionsDate() {
            // Fetch available dates
            const res = await fetch('/api/v1/actions/dates');
            const dates = await res.json();
            if (dates.length > 0) {
                // select latest
                document.getElementById('actions-date').value = dates[0]; // assumes sorted desc
                loadActions();
            }
        }

        async function generateActions() {
            const pyramiding = document.getElementById('pyramid-toggle').checked;
            showLoading('Generating Actions...');
            try {
                let url = '/api/v1/actions/generate?config_name=momentum_config';
                if (pyramiding) url += '&enable_pyramiding=true';
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    alert('Actions Generated: ' + data.message);
                    loadActions();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (e) { alert(e.message); }
            hideLoading();
        }

        async function loadActions() {
            const date = document.getElementById('actions-date').value;
            if (!date) return;

            showLoading('Loading Actions...');
            const res = await fetch(`/api/v1/actions/?date=${date}`);
            const actions = await res.json();

            destroyDataTable('#actions-table');
            const tbody = document.getElementById('actions-body');
            tbody.innerHTML = '';

            if (!actions.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No actions found</td></tr>';
                hideLoading();
                return;
            }

            actions.forEach(a => {
                const badgeClass = a.type === 'buy' ? 'badge-buy' : a.type === 'sell' ? 'badge-sell' : 'badge-swap';

                let actionBtn = '';
                if (a.status === 'Pending') {
                    actionBtn = `
                    <button class="badge badge-buy" style="border:none;cursor:pointer;" onclick="openApproveModal('${a.action_id}', '${a.symbol}', ${a.units}, ${a.execution_price || a.prev_close || 0})">Approve</button>
                        <button class="badge badge-sell" style="border:none;cursor:pointer;" onclick="updateAction('${a.action_id}', 'Rejected')">Reject</button>
                `;
                }

                tbody.innerHTML += `<tr>
                    <td data-sort="${a.action_date}">${a.action_date}</td>
                    <td data-sort="${a.type}"><span class="badge ${badgeClass}">${a.type.toUpperCase()}</span></td>
                    <td><b>${a.symbol}</b></td>
                    <td data-sort="${a.units}">${a.units}</td>
                    <td data-sort="${a.execution_price || a.prev_close || 0}">${a.execution_price || a.prev_close || '-'}</td>
                    <td data-sort="${a.stop_loss || 0}">${a.stop_loss ? '‚Çπ' + parseFloat(a.stop_loss).toFixed(2) : '-'}</td>
                    <td data-sort="${a.status}">${a.status}</td>
                    <td style="font-size:0.8rem; color:#aaa;">${a.reason || ''}</td>
                    <td class="text-center">${actionBtn}</td>
                </tr>`;
            });
            hideLoading();
            makeTableSortable('#actions-table', { searching: true });
        }

        async function updateAction(id, status) {
            await fetch(`/api/v1/actions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            loadActions();
        }

        async function approveAll() {
            const date = document.getElementById('actions-date').value;
            if (!confirm('Approve all pending actions for ' + date + '?')) return;

            await fetch(`/api/v1/actions/approve?date=${date}&config_name=momentum_config`, { method: 'POST' });
            loadActions();
        }

        async function rejectPending() {
            // Not exposed as bulk endpoint in plan, but can iterate or add backend endpoint. 
            // Ideally we add a backend endpoint, but for now lets skip implementation or do loop
            alert("Feature requires backend endpoint '/reject-all'. Use individual reject for now.");
        }

        async function processActions() {
            const date = document.getElementById('actions-date').value;
            if (!confirm('Process all APPROVED actions into holdings for ' + date + '?')) return;

            await fetch(`/api/v1/actions/process?date=${date}`, { method: 'POST' });
            alert('Processing complete. Check Portfolio.');
            loadActions();
        }

        // --- APPROVE MODAL ---
        function openApproveModal(actionId, symbol, units, price) {
            document.getElementById('approve-action-id').value = actionId;
            document.getElementById('approve-symbol').value = symbol;
            document.getElementById('approve-units').value = units;
            document.getElementById('approve-price').value = price;
            document.getElementById('approve-modal-title').innerText = 'Approve: ' + symbol;
            document.getElementById('approve-modal').classList.remove('hidden');
        }

        function closeApproveModal() {
            document.getElementById('approve-modal').classList.add('hidden');
        }

        async function confirmApprove() {
            const actionId = document.getElementById('approve-action-id').value;
            const units = parseInt(document.getElementById('approve-units').value);
            const price = parseFloat(document.getElementById('approve-price').value);

            if (!units || !price) {
                alert('Please enter valid units and execution price.');
                return;
            }

            await fetch(`/api/v1/actions/${actionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'Approved', units: units, execution_price: price.toString() })
            });
            closeApproveModal();
            loadActions();
        }

        // --- EQUITY CURVE & DRAWDOWN ---
        let equityChartInstance = null;
        let drawdownChartInstance = null;

        async function loadEquityCurve() {
            try {
                const res = await fetch('/api/v1/investment/summary/history');
                const data = await res.json();
                if (!data || !data.length) return;

                const labels = data.map(d => d.date);
                const values = data.map(d => parseFloat(d.portfolio_value || 0));

                // Compute drawdown
                let peak = values[0];
                const drawdowns = values.map(v => {
                    if (v > peak) peak = v;
                    return peak > 0 ? ((v - peak) / peak) * 100 : 0;
                });

                // Equity Curve
                const eqCtx = document.getElementById('equityCurveChart').getContext('2d');
                if (equityChartInstance) equityChartInstance.destroy();

                const gradient = eqCtx.createLinearGradient(0, 0, 0, 280);
                gradient.addColorStop(0, 'rgba(0, 200, 150, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 200, 150, 0.02)');

                equityChartInstance = new Chart(eqCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: values,
                            borderColor: '#00c896',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: true, ticks: { maxTicksLimit: 8, color: '#888' }, grid: { display: false } },
                            y: { display: true, ticks: { color: '#888', callback: v => '‚Çπ' + (v / 1000).toFixed(0) + 'K' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });

                // Drawdown Chart
                const ddCtx = document.getElementById('drawdownChart').getContext('2d');
                if (drawdownChartInstance) drawdownChartInstance.destroy();

                const ddGradient = ddCtx.createLinearGradient(0, 0, 0, 280);
                ddGradient.addColorStop(0, 'rgba(255, 75, 75, 0.02)');
                ddGradient.addColorStop(1, 'rgba(255, 75, 75, 0.25)');

                drawdownChartInstance = new Chart(ddCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Drawdown %',
                            data: drawdowns,
                            borderColor: '#ff4b4b',
                            backgroundColor: ddGradient,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: true, ticks: { maxTicksLimit: 8, color: '#888' }, grid: { display: false } },
                            y: { display: true, ticks: { color: '#888', callback: v => v.toFixed(1) + '%' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            } catch (e) {
                console.error('Equity curve error:', e);
            }
        }

        // --- TRADE JOURNAL ---
        async function loadTradeJournal() {
            try {
                const res = await fetch('/api/v1/investment/trade-journal');
                const trades = await res.json();
                destroyDataTable('#journal-table');
                const tbody = document.getElementById('journal-body');
                tbody.innerHTML = '';

                if (!trades || !trades.length) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding:20px;">No closed trades yet</td></tr>';
                    makeTableSortable('#journal-table');
                    return;
                }

                trades.forEach(t => {
                    const pnlClass = t.pnl >= 0 ? 'pos-val' : 'neg-val';
                    tbody.innerHTML += `<tr>
                        <td data-sort="${t.entry_date}">${t.entry_date}</td>
                        <td data-sort="${t.exit_date}">${t.exit_date}</td>
                        <td><b>${t.symbol}</b></td>
                        <td data-sort="${t.units}">${t.units}</td>
                        <td class="text-right" data-sort="${t.entry_price}">‚Çπ${t.entry_price.toFixed(2)}</td>
                        <td class="text-right" data-sort="${t.exit_price}">‚Çπ${t.exit_price.toFixed(2)}</td>
                        <td class="text-right ${pnlClass}" data-sort="${t.pnl}">‚Çπ${t.pnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="text-right ${pnlClass}" data-sort="${t.return_pct}">${t.return_pct.toFixed(2)}%</td>
                        <td data-sort="${t.days_held}">${t.days_held}</td>
                        <td style="font-size:0.8rem;color:#aaa;">${t.reason}</td>
                    </tr>`;
                });
                makeTableSortable('#journal-table', { searching: true, paging: true, pageLength: 15, info: true, order: [[1, 'desc']] });
            } catch (e) {
                console.error('Trade journal error:', e);
                document.getElementById('journal-body').innerHTML = '<tr><td colspan="10" class="text-center">Failed to load</td></tr>';
            }
        }

        // --- CONFIG ---
        async function loadConfig() {
            const name = document.getElementById('config-select').value;
            const res = await fetch(`/api/v1/config/${name}`);
            const data = await res.json();

            document.getElementById('conf-initial').value = data.initial_capital;
            document.getElementById('conf-risk').value = data.risk_threshold;
            document.getElementById('conf-max').value = data.max_positions;
            document.getElementById('conf-min').value = data.min_position_percent;
            document.getElementById('conf-exit').value = data.exit_threshold;
            document.getElementById('conf-sl-mult').value = data.sl_multiplier;
        }

        async function saveConfig() {
            const name = document.getElementById('config-select').value;
            const payload = {
                initial_capital: parseFloat(document.getElementById('conf-initial').value),
                risk_threshold: parseFloat(document.getElementById('conf-risk').value),
                max_positions: parseInt(document.getElementById('conf-max').value),
                min_position_percent: parseFloat(document.getElementById('conf-min').value),
                exit_threshold: parseFloat(document.getElementById('conf-exit').value),
                sl_multiplier: parseFloat(document.getElementById('conf-sl-mult').value),
            };

            await fetch(`/api/v1/config/${name}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            alert('Configuration Saved!');
        }

        // --- BACKTEST ---
        function initBacktestDates() {
            const today = new Date();
            const start = new Date();
            start.setFullYear(today.getFullYear() - 1);
            document.getElementById('bt-start').value = start.toISOString().split('T')[0];
            document.getElementById('bt-end').value = today.toISOString().split('T')[0];
        }

        let backtestChartInstance = null;

        async function runBacktest() {
            const label = document.getElementById('bt-label').value.trim();
            const payload = {
                start_date: document.getElementById('bt-start').value,
                end_date: document.getElementById('bt-end').value,
                config_name: document.getElementById('bt-config').value,
                check_daily_sl: document.getElementById('bt-daily-sl').checked,
                mid_week_buy: document.getElementById('bt-mid-week').checked,
                enable_pyramiding: document.getElementById('bt-pyramid').checked
            };
            if (label) payload.run_label = label;

            showLoading('Running Backtest... (this takes time)');
            try {
                const res = await fetch('/api/v1/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    populateBacktestResults(data);
                    // Refresh history list since a new run was saved
                    loadBacktestHistory();
                } else {
                    alert('Backtest Failed: ' + data.message);
                }

            } catch (e) { console.error(e); alert('Error running backtest'); }
            hideLoading();
        }

        function populateBacktestResults(data) {
            document.getElementById('bt-results').classList.remove('hidden');

            const sum = data.summary || {};

            document.getElementById('bt-return').innerText = (sum.total_return || 0).toFixed(2) + '%';
            document.getElementById('bt-sharpe').innerText = (sum.sharpe_ratio || 0).toFixed(2);
            document.getElementById('bt-dd').innerText = (sum.max_drawdown || 0).toFixed(2) + '%';
            document.getElementById('bt-winrate').innerText = (sum.win_rate || 0).toFixed(2) + '%';

            document.getElementById('bt-costs').innerText = '‚Çπ' + (sum.total_transaction_costs || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('bt-tax').innerText = '‚Çπ' + (sum.total_tax || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const netRetPct = sum.net_post_tax_return_pct || 0;
            const netRetAbs = sum.net_post_tax_return || 0;
            document.getElementById('bt-net-ret').innerText = `‚Çπ${netRetAbs.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${netRetPct.toFixed(2)}%)`;

            const grossGain = (sum.final_value || 0) - (sum.initial_capital || 0);
            let eff = 0;
            if (grossGain > 0) {
                eff = (netRetAbs / grossGain) * 100;
            }
            document.getElementById('bt-efficiency').innerText = eff.toFixed(1) + '% retained';

            // Render YoY Returns
            destroyDataTable('#bt-yoy-table');
            const yoyBody = document.getElementById('bt-yoy-body');
            yoyBody.innerHTML = '';
            if (sum.yearly_returns && sum.yearly_returns.length > 0) {
                document.getElementById('bt-yoy-card').classList.remove('hidden');
                sum.yearly_returns.forEach(y => {
                    const retClass = y.return_pct >= 0 ? 'pos-val' : 'neg-val';
                    const tr = `<tr>
                        <td><strong>${y.year}</strong></td>
                        <td class="text-right ${retClass}">${y.return_pct.toFixed(2)}%</td>
                        <td class="text-right ${retClass}">‚Çπ${y.pnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="text-right">‚Çπ${y.end_value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>`;
                    yoyBody.innerHTML += tr;
                });
                makeTableSortable('#bt-yoy-table', { searching: false, paging: false, order: [[0, 'asc']] });
            } else {
                document.getElementById('bt-yoy-card').classList.add('hidden');
            }

            // Render Chart
            renderEquityChart(data.equity_curve || []);

            // Render Trades
            destroyDataTable('#bt-trades-table');
            const tbody = document.getElementById('bt-trades-body');
            tbody.innerHTML = '';
            const trades = data.trades || [];
            const sellTrades = trades.filter(t => t.type === 'SELL');

            sellTrades.forEach(t => {
                const investedValue = (t.price || 0) * (t.units || 1);
                const retPct = investedValue > 0 ? ((t.pnl / investedValue) * 100).toFixed(2) : '0.00';
                const tr = `<tr>
                    <td>${t.symbol}</td>
                    <td data-sort="${t.type}">${t.type}</td>
                    <td data-sort="${t.entry_date}">${t.entry_date}</td>
                    <td data-sort="${t.exit_date}">${t.exit_date}</td>
                    <td class="text-right ${t.pnl >= 0 ? 'pos-val' : 'neg-val'}" data-sort="${t.pnl}">${t.pnl.toFixed(2)}</td>
                    <td class="text-right" data-sort="${retPct}">${retPct}%</td>
                </tr>`;
                tbody.innerHTML += tr;
            });
            makeTableSortable('#bt-trades-table', { searching: true, paging: true, pageLength: 10, info: true });

            // Render Open Positions at Backtest End
            destroyDataTable('#bt-open-positions-table');
            const openBody = document.getElementById('bt-open-positions-body');
            openBody.innerHTML = '';
            const openPositions = sum.open_positions || [];
            if (openPositions.length > 0) {
                document.getElementById('bt-open-positions-card').classList.remove('hidden');
                openPositions.forEach(p => {
                    const pnlClass = p.unrealized_pnl >= 0 ? 'pos-val' : 'neg-val';
                    const tr = `<tr>
                        <td><b>${p.symbol}</b></td>
                        <td data-sort="${p.entry_date}">${p.entry_date}</td>
                        <td class="text-right" data-sort="${p.units}">${p.units}</td>
                        <td class="text-right">‚Çπ${p.avg_price.toFixed(2)}</td>
                        <td class="text-right">‚Çπ${p.current_price.toFixed(2)}</td>
                        <td class="text-right" data-sort="${p.market_value}">‚Çπ${p.market_value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="text-right ${pnlClass}" data-sort="${p.unrealized_pnl}">‚Çπ${p.unrealized_pnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>`;
                    openBody.innerHTML += tr;
                });
                makeTableSortable('#bt-open-positions-table', { searching: false, order: [[5, 'desc']] });
            } else {
                document.getElementById('bt-open-positions-card').classList.add('hidden');
            }

            // Raw log
            document.getElementById('bt-raw-log').innerText = data.report_text || '';
        }

        // --- BACKTEST HISTORY ---
        async function loadBacktestHistory() {
            try {
                const res = await fetch('/api/v1/backtest/history');
                const runs = await res.json();
                destroyDataTable('#bt-history-table');
                const tbody = document.getElementById('bt-history-body');
                tbody.innerHTML = '';

                if (!runs || !runs.length) {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center">No saved runs</td></tr>';
                    makeTableSortable('#bt-history-table');
                    return;
                }

                runs.forEach((r, i) => {
                    const retClass = (r.total_return || 0) >= 0 ? 'pos-val' : 'neg-val';
                    const ddVal = r.max_drawdown != null ? r.max_drawdown.toFixed(2) : '-';
                    const sharpeVal = r.sharpe_ratio != null ? r.sharpe_ratio.toFixed(2) : '-';
                    const retVal = r.total_return != null ? r.total_return.toFixed(2) : '-';
                    const created = r.created_at ? r.created_at.substring(0, 16).replace('T', ' ') : '-';
                    const dailySl = r.check_daily_sl ? '‚úì' : '‚úó';
                    const mwb = r.mid_week_buy ? '‚úì' : '‚úó';

                    tbody.innerHTML += `<tr>
                        <td data-sort="${r.id}">${r.id}</td>
                        <td>${r.run_label || '<em style="color:#666;">‚Äî</em>'}</td>
                        <td data-sort="${r.config_name}">${r.config_name || '-'}</td>
                        <td style="white-space:nowrap;" data-sort="${r.start_date}">${r.start_date} ‚Üí ${r.end_date}</td>
                        <td class="text-center" data-sort="${r.check_daily_sl}">${dailySl}</td>
                        <td class="text-center" data-sort="${r.mid_week_buy}">${mwb}</td>
                        <td class="text-right ${retClass}" data-sort="${r.total_return}">${retVal}%</td>
                        <td class="text-right" style="color:var(--danger);" data-sort="${r.max_drawdown}">${ddVal}%</td>
                        <td class="text-right" data-sort="${r.sharpe_ratio}">${sharpeVal}</td>
                        <td style="font-size:0.8rem; color:#888;" data-sort="${r.created_at}">${created}</td>
                        <td class="text-center" style="white-space:nowrap;">
                            <button class="badge badge-buy" style="border:none; cursor:pointer; margin-right:4px;" onclick="loadBacktestRun(${r.id})">Load</button>
                            <button class="badge badge-sell" style="border:none; cursor:pointer;" onclick="deleteBacktestRun(${r.id})">Del</button>
                        </td>
                    </tr>`;
                });
                makeTableSortable('#bt-history-table', { searching: false, order: [[0, 'desc']] });
            } catch (e) {
                console.error('Failed to load backtest history:', e);
            }
        }

        async function loadBacktestRun(runId) {
            showLoading('Loading backtest run...');
            try {
                const res = await fetch(`/api/v1/backtest/history/${runId}`);
                const data = await res.json();
                if (res.ok) {
                    populateBacktestResults(data);
                    // Scroll to results
                    document.getElementById('bt-results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Failed to load run: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Error loading backtest run');
            }
            hideLoading();
        }

        async function deleteBacktestRun(runId) {
            if (!confirm('Delete this backtest run? This will also remove the data files.')) return;
            try {
                const res = await fetch(`/api/v1/backtest/history/${runId}`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    loadBacktestHistory();
                } else {
                    alert('Failed to delete: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting backtest run');
            }
        }

        function renderEquityChart(equityCurve) {
            const ctx = document.getElementById('equityChart').getContext('2d');

            if (backtestChartInstance) {
                backtestChartInstance.destroy();
            }

            // equityCurve is [{date, value}, ...] from the API
            const labels = equityCurve.map(p => p.date || '');
            const values = equityCurve.map(p => p.value);

            backtestChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Equity',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: { maxTicksLimit: 8, color: '#94a3b8' },
                            grid: { display: false }
                        },
                        y: {
                            grid: { color: '#2d3748' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        async function refreshPortfolio() {
            // Always sync latest
            showLoading('Syncing Prices...');
            try {
                const res = await fetch('/api/v1/investment/sync-prices', { method: 'POST' });
                const dat = await res.json();
                if (!res.ok) throw new Error(dat.message);
                console.log("Sync complete:", dat.message);
            } catch (e) {
                console.error("Failed to sync prices", e);
            }
            await loadPortfolio();
            hideLoading();
        }

        // --- LIVE PRICE STREAMING ---
        let _liveInterval = null;
        let _isLive = false;

        // Live PnL Chart vars
        let livePnlChartInstance = null;
        let livePnlLabels = [];
        let livePnlData = [];

        function initLivePnlChart() {
            const ctx = document.getElementById('livePnlChart').getContext('2d');
            if (livePnlChartInstance) return;

            livePnlChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: livePnlLabels,
                    datasets: [{
                        label: "Today's P&L",
                        data: livePnlData,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 10, color: '#888' }, grid: { display: false } },
                        y: { display: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        async function toggleLiveStream() {
            if (_isLive) {
                stopLiveStream();
            } else {
                await startLiveStream();
            }
        }

        async function startLiveStream() {
            const btn = document.getElementById('live-toggle-btn');
            const label = document.getElementById('live-status-label');
            btn.innerText = '‚è≥ Starting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/v1/investment/start-ticker', { method: 'POST' });
                const data = await res.json();
                if (!res.ok) {
                    alert('Failed to start ticker: ' + (data.message || 'Unknown error'));
                    btn.innerText = 'üì° Go Live';
                    btn.disabled = false;
                    return;
                }

                _isLive = true;
                btn.innerText = '‚è∏ Stop Live';
                btn.style.background = 'var(--danger)';
                btn.disabled = false;
                label.innerText = 'üü¢ Streaming live';
                label.style.color = 'var(--accent)';

                // Initialize live chart
                livePnlLabels = [];
                livePnlData = [];
                document.getElementById('live-pnl-card').style.display = 'block';
                initLivePnlChart();
                livePnlChartInstance.update();

                // Start polling every 30 seconds
                pollLivePrices(); // immediate first poll
                _liveInterval = setInterval(pollLivePrices, 30000);

            } catch (e) {
                console.error('Start live error:', e);
                btn.innerText = 'üì° Go Live';
                btn.disabled = false;
            }
        }

        function stopLiveStream() {
            if (_liveInterval) {
                clearInterval(_liveInterval);
                _liveInterval = null;
            }
            _isLive = false;

            const btn = document.getElementById('live-toggle-btn');
            btn.innerText = 'üì° Go Live';
            btn.style.background = 'var(--accent)';

            const label = document.getElementById('live-status-label');
            label.innerText = '‚è∏ Not streaming';
            label.style.color = 'var(--text-muted)';

            // Fire-and-forget stop
            fetch('/api/v1/investment/stop-ticker', { method: 'POST' }).catch(() => { });
        }

        async function pollLivePrices() {
            try {
                const res = await fetch('/api/v1/investment/live-prices');
                const data = await res.json();
                if (!data.prices) return;

                const prices = data.prices;
                const rows = document.querySelectorAll('#holdings-body tr[data-symbol]');
                let totalDayPnl = 0;
                let totalVal = 0;
                let totalPnl = 0;

                const dt = $('#holdings-table').DataTable();

                rows.forEach(row => {
                    const sym = row.getAttribute('data-symbol');
                    const p = prices[sym];
                    if (!p || !p.last_price) return;

                    const units = parseFloat(row.children[2].getAttribute('data-sort') || 0);
                    const entryPrice = parseFloat(row.children[3].getAttribute('data-sort') || 0);
                    const ltp = p.last_price;
                    const prevClose = p.prev_close || 0;

                    const newVal = ltp * units;
                    const inv = entryPrice * units;
                    const pnl = newVal - inv;
                    const pnlPct = inv !== 0 ? (pnl / inv) * 100 : 0;
                    const dayPnl = (ltp - prevClose) * units;

                    totalVal += newVal;
                    totalPnl += pnl;
                    totalDayPnl += dayPnl;

                    // Update cells using DataTables API to preserve sorting
                    // Assuming columns: Symbol(0), Entry Date(1), Units(2), Avg Price(3), Current(4), SL(5), Cap Risk(6), Invested(7), Value(8), Unrealized P&L(9), %(10), Day P&L(11)

                    const dtRow = dt.row(row);

                    // Helper to update text and sorting value
                    function updateCell(colIdx, sortVal, htmlStr) {
                        const cell = dt.cell(dtRow, colIdx);
                        const node = cell.node();
                        if (node) {
                            node.setAttribute('data-sort', sortVal);
                            node.innerHTML = htmlStr;
                        }
                        cell.invalidate('dom'); // Tell DataTables to re-read the data-sort and text from DOM
                    }

                    // Col 4: Current Price
                    updateCell(4, ltp, `‚Çπ${ltp.toFixed(2)}`);

                    // Col 8: Value
                    updateCell(8, newVal, `‚Çπ${newVal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);

                    // Col 9: Unrealized P&L
                    const pnlClass = pnl >= 0 ? 'pos-val' : 'neg-val';
                    updateCell(9, pnl, `<span class="${pnlClass}">‚Çπ${pnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`);

                    // Col 10: %
                    const pnlPctClass = pnlPct >= 0 ? 'pos-val' : 'neg-val';
                    updateCell(10, pnlPct, `<span class="${pnlPctClass}">${pnlPct.toFixed(2)}%</span>`);

                    // Col 11: Day P&L
                    const dayPnlClass = dayPnl >= 0 ? 'pos-val' : 'neg-val';
                    updateCell(11, dayPnl, `<span class="${dayPnlClass}">‚Çπ${dayPnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`);
                });

                // Redraw table to apply sorting/filtering updates without resetting pagination
                dt.draw(false);

                // Update footer totals
                const totalValEl = document.getElementById('live-total-val');
                if (totalValEl) totalValEl.innerHTML = `‚Çπ${totalVal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const totalPnlEl = document.getElementById('live-total-pnl');
                if (totalPnlEl) {
                    totalPnlEl.className = `text-right ${totalPnl >= 0 ? 'pos-val' : 'neg-val'}`;
                    totalPnlEl.innerHTML = `‚Çπ${totalPnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                const totalDayEl = document.getElementById('live-total-day-pnl');
                if (totalDayEl) {
                    totalDayEl.className = `text-right ${totalDayPnl >= 0 ? 'pos-val' : 'neg-val'}`;
                    totalDayEl.innerHTML = `‚Çπ${totalDayPnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                // Update summary card
                const dayPnlCard = document.getElementById('sum-day-pnl');
                if (dayPnlCard) {
                    dayPnlCard.className = `metric-value ${totalDayPnl >= 0 ? 'pos-val' : 'neg-val'}`;
                    dayPnlCard.innerText = `‚Çπ${totalDayPnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                // Update live chart
                if (livePnlChartInstance) {
                    const now = new Date();
                    const timeStr = String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0') + ':' +
                        String(now.getSeconds()).padStart(2, '0');
                    livePnlLabels.push(timeStr);
                    livePnlData.push(totalDayPnl);

                    if (livePnlLabels.length > 120) { // keep last 1 hour of points at 30s interval
                        livePnlLabels.shift();
                        livePnlData.shift();
                    }

                    livePnlChartInstance.data.datasets[0].borderColor = totalDayPnl >= 0 ? '#10b981' : '#ef4444';
                    livePnlChartInstance.data.datasets[0].backgroundColor = totalDayPnl >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    livePnlChartInstance.update();
                }

                // Update portfolio value card too
                const valCard = document.getElementById('sum-val');
                if (valCard && totalVal > 0) {
                    const cashCard = document.getElementById('sum-cash');
                    let cashVal = 0;
                    if (cashCard && cashCard.innerText) {
                        cashVal = parseFloat(cashCard.innerText.replace(/[^0-9.-]+/g, '')) || 0;
                    }
                    valCard.innerText = `‚Çπ${(totalVal + cashVal).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                // Update unrealized PnL card
                const unrealizedCard = document.getElementById('sum-unrealized');
                if (unrealizedCard) {
                    unrealizedCard.className = `metric-value ${totalPnl >= 0 ? 'pos-val' : 'neg-val'}`;
                    unrealizedCard.innerText = `‚Çπ${totalPnl.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

            } catch (e) {
                console.error('Poll live prices error:', e);
            }
        }

    </script>
</body>

</html>